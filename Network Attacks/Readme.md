Assignment 6: Understanding Subverting HTTPS Through Side Channels
Assignment 6 is about using Wireshark to explore traffic on a wi-fi network and explore the security implications and then to exploit side channels in that network traffic to reconstruct browsing conducted over the encrypted HTTPS protocol.

The Broad Setting of this Assignment
"HTTPS traffic is encrypted. Therefore, no one can know what I'm browsing." <-- A false statement spoken by someone who has not taken CS 232.
The John Crerar Library is haunted! Here in JCL, the Ghost of CS Students Past (subsequently abbreviated "Ghost") died an untimely death in JCL one night when the Bomb Project unexpectedly exploded. Some say Ghost still sits in the halls of JCL all day and night, mindlessly browsing the same website over and over. Thankfully, Ghost is primarily visiting a website created by someone who took Intro to Security, so the site is available over HTTPS.

Unfortunately, Ghost's privacy is not actually safe. Might it still be possible to reconstruct precisely what they browsed even though they're using a version of HTTPS without any known vulnerabilities? The answer is yes, and in this assignment you will do so by exploiting a side channel.

Leveraging Wireshark (network analysis software that is widely used in industry), Blase has snooped on Ghost's network traffic to grab the relevant traffic generated by Ghost, which is mixed in with incidental traffic caused by other processes running on Ghost's computer. Specifically, Blase put his computer's wi-fi card into monitor mode (snooping on all traffic from all networks on a particular frequency band) using the aircrack-ng tool. Please download the capture file. Note that this is a lossy, probabilistic process, so you won't actually see all of the traffic. In this assignment, it will be up to you to make sense of these packet captures.

To help you along in understanding what is happening in this file, we are asking a number of leading questions, as well as a few other questions that verify your ability to translate concepts from lectures to data you observe in the real world. At a high level (details follow later in this document), here's what you will do:

First, you'll comb through the given network traffic manually and use context clues to figure out which traffic is Ghost's and gain an initial understanding of what is happening. You'll then start thinking about how you can use side channel information leaked on the network, even for HTTPS traffic, to learn which website they were visiting.

Second, once you know what website they were visiting, can you use additional information leaked in this traffic to determine exactly which page they were visiting even though the traffic is encrypted using TLS? SIZE UP this traffic (cough cough). In this step, write code to pre-process the relevant data about the relevant traffic you observe in the packet captures. Throw out irrelevant traffic, and associate related flows that originated from visiting a single page. You'll use your pre-processed version of the traffic in this next step.

Third, you'll need to do some measurement yourself on that website. By cross-referencing your measurements with the pre-processed traffic from the previous step and utlizing the information leak you observed, you'll be able to determine exactly which pages on the website Ghost visited, in which order. You are permitted (and in fact strongly encouraged) to do this step (visiting pages and cross-referencing what you observe with your measurements) manually for identifying the first few sites Ghost visited. That is, you will trace by hand to figure out the first 2 or 3 pages Ghost visited.

Fourth, you'll use a browser-automation tool called Selenium to write code that automates the measurement and analysis process you used in the previous step. By doing so, you can uncover the full set of 20 pages that Ghost visited on a particular domain we own without having to do the analysis by hand!

Detailed Tech Set-Up and Overview
We wrote our reference solution in Python 3. While we will be able to provide the most comprehensive support for doing this assignment in Python, you ultimately may write code in whatever language you feel most comfortable with. Just make sure that your language of choice has a good library for parsing a JSON file.

Step 0: Downloading Wireshark (Prerequisite for the rest)
You'll need Wireshark for several steps of this assignment. Wireshark is a free and open-source tool for analyzing network traffic. Wireshark can be downloaded from https://www.wireshark.org/#downloadLinks to an external site. or installed via your favorite package manager (e.g., apt on Ubuntu Linux). For Macs, it is easier to just download Wireshark from the website and follow the instructions. (Note that you might run into problems installing naively via brew on a Mac, though some quick web searches should point you in the right direction.) Be careful to pick the appropriate binary for Macs (M1 = ARM, older Macs = Intel). For Windows, you most likely want a 64-bit binary, but it's your choice about whether to install it natively or use the portable app.

What to submit in terms of code/output. Nothing for this step.

Step 1: Basics of Examining Network Traffic (23 points)
In this step, you'll start making sense of the data Blase captured by looking through it manually. Open the packet capture file capture1.pcapng in Wireshark since the filters and graphical interface will likely help you comb through this traffic. Note that Ghost is on a local wi-fi router and has the (private) IP address 192.168.0.100. Note also that Ghost is connected to the wi-fi network with SSID "securityclass", but because we were in monitor mode, we've inadvertently picked up traffic from a number of other wi-fi networks in JCL.

Hints:

In Wireshark, you can use the filter command ip.addr == 192.168.0.100 to look only at traffic related to a particular IP address. As this is a computer running a real operating system, you will see some incidental traffic that is not relevant to the assignment.

Reading up on Wireshark filtersLinks to an external site. will make these tasks much easier.

Writeup Question 1 (1 point) Look at some of the early packets in Wireshark. What are the SSIDs of 4 networks other than "securityclass" whose traffic has been inadvertently collected in this packet capture?

Writeup Question 2 (1 point) Now, let's only look at DNS traffic by typing "dns" into the filter bar up top in Wireshark and hitting enter. You should see about a page worth of traffic. Look at the query in row number 4361. In your own words, explain what is being queried/requested in this DNS request (specifically why such a request might need to be made).

Writeup Question 3 (2 points) In what row number do you find the answer to this query, and what is the ultimate IP address the client is being directed to?

Writeup Question 4 (1 point) Now repeat the process for the DNS query in row 4719, but for this question, just list the final IP address of the server being contacted. What is the destination IP address of the first HTTP request sent by Ghost? (HTTP should be in the protocol)

Writeup Question 5 (1 point) Use Wireshark filtersLinks to an external site. to look only at the traffic between the host identified in the previous question and Ghost (in both directions). First, we'll look only at traffic that occurs between 22 and 24 seconds into this packet capture. How many HTTP requests are made, and what are the specific items being requested?

Writeup Question 6 (1 points) For the first HTTP resource being requested between 22 and 24 seconds into the packet capture, find the response (shown in Wireshark with "HTTP" in the protocol column). Note that this particular type of row in Wireshark is actually a reconstruction (reassembly) of other rows. What row number is this "HTTP" response in the packet capture file, what was the port number used on Ghost's computer, and what was the port number used on the UChicago-related server?

Writeup Question 7 (1 point) Building on the previous question, how many bytes were sent in this HTTP response? Additionally, we strongly encourage you to look carefully through the different headers (IP, TCP, HTTP) in this reconstructed HTTP response and try to understand how everything is encapsulated; you can even see the HTML of the webpage!

Writeup Question 8 (2 point) Now, look for the raw "TCP" protocol packets around the same time (and between the Ghost and this same server) in this same capture file. How are Seq and Ack changing in responding to this request (providing this resource), and what do they ultimately represent (specifically in relation to the previous questions)?

Writeup Question 9 (1 point) Is the second HTTP resource that was requested returned on the same combination of ports, or a different one?

Writeup Question 10 (1 point) Make a list of all resources requested in loading this page alongside what ports are being used for each. What do you notice? Also, note which resources were successfully returned, and which were ultimately not found

Writeup Question 11 (2 points) Find the FIN,ACK messages in row 6558 of this packet capture. What does this represent?

Writeup Question 12 (2 points) Between 30 and 33 seconds into this packet capture, Ghost visits another website. What website is the ghost visiting, and what specifically do they seem to be doing on this website? Why does this information leak?

Writeup Question 13 (1 point) Now that Ghost has visited these two previous pages, they eventually start browsing a different page. Look for a different IP address on the UChicago network that Ghost communicates with for much of the rest of this packet capture. What is that IP address?

Writeup Question 14 (2 points) The IP address from the previous question is a web server that hosts a number of websites. What is the domain (e.g., example.com) of the website at that IP address that Ghost is actually visiting, and how did you determine this? (Hint: If you are reading Blase's research group's website, you'll have to keep looking for more clues.)

Writeup Question 15 (2 points) What is the first page Ghost visits on that website, and how did you determine this? (Hint: Ghost does something non-optimal that leaks the first page they are trying to visit.) What happens after Ghost makes the initial request for that page?

Writeup Question 16 (2 points) Look broadly at the rest of the traffic. Briefly describe what you see, especially attributes you notice changing over time over the network trace. (We're looking for your general observations of what is and is not contained in the traffic you see, as well as what is changing over time. The latter will help you in future steps.)

What to submit in terms of code/output. Nothing for this step. You will just submit the answers to the above on Gradescope by pasting in your answers to textboxes on Gradescope.

Step 2: Measuring the Next Page Visited on the Website (12 points)
In Step 1 (Question 15), you determined the first page Ghost visited on the website. In this step, you will manually determine the second page Ghost visited on the website. The difficulty here is that now Ghost is visiting pages over HTTPS, so everything is encrypted! Shouldn't that make it impossible to reconstruct? The answer, surprisingly, is often NO!

To make it easier, let's make some assumptions. Assume that all of Ghost's subsequent browsing over HTTPS came only from clicking on links on the previous page. They didn't type anything into the URL bar, hit the back button, or anything like that. In other words, at each step, there are only a few possible next steps. How might you determine which page Ghost was visiting? Well, try to retrace Ghost's steps yourself and see what network traffic that page visit generates.

To do so, you will capture your own network traffic as you visit pages Ghost might have visited. Fire up Wireshark on your own computer and observe your own network traffic and see what happens when you visit each page linked from the first page Ghost visited. Try visiting different pages while running a packet capture in Wireshark, stop the capture, then analyze the packets that correspond to the pages you visited. To mimic Ghost's behavior as you explore, visit the pages in Firefox with caching disabled in your browser and your previous browsing history cleared. Capturing your own traffic involves following Steps 1-3 from this guideLinks to an external site..

Important hints and assumptions follow:

Ghost's browser was configured not to cache anything- that is, the requests it makes for a page are as if it is requesting those resources for the first time (it won't save images, etc.).
Ghost was using Mozilla Firefox. (You should see similar patterns on other browsers, but using Firefox might help make it easier to replicate Ghost's traffic more closely.)
You might notice that these are some strong assumptions that will make your task much, much easier. That said, research over the past decade has shown that the same sort of techniques you are using can also be adjusted for cases with far weaker assumptions.

Extra information for your own edification:

Wouldn't it be interesting if you could see the other traffic on your network, beyond your own computer? It's possible (modulo many assumptions about your network hardware and wi-fi card, your operating system, and much more). You will need to put your wi-fi card into promiscuous mode and/or monitor mode to do so. Note that you must only do this on a network you have complete permission to sniff!!! Don't distract yourself trying to get this to work until the assignment is fully completed. On newer Macs, it's unfortunately basically impossible to do this. Even for Blase to get this to work on Linux took hours of debugging.
Writeup Question 17 (5 points) List the second page Ghost visited.

Writeup Question 18 (3 points) Describe and justify your approach for answering the previous question.

Writeup Question 19 (4 points) What problems will your approach in this section face in the real world without the somewhat artificial ways in which we limited Ghost's browsing, or on webpages with different structures? At a high level, how might you try to overcome some of those difficulties?

What to submit in terms of code/output (0 points). Submit the additional code you wrote for this part, if any. Note that no additional code may have been required depending on how manually you approached identifying the second page. Please use the prefix step2 with whatever suffixes you want (e.g., step2CleaningCode.py).

Step 3: Pre-Processing and Filtering the Network Data (15 points)
Now that you know what website Ghost was visiting (from Step 1), the first page Ghost visited on that website (over HTTP, from Step 1), and amazingly the second page Ghost visited (over HTTPS, from Step 2), can you continue to use the side channel information leaked in HTTPS traffic to determine the full set of 21 additional pages Ghost visited subsequently? As we hinted before, maybe the number and size of data flows you observe could be useful here. Maybe the attributes you noticed changing (or not changing) above will also help. As you'll observe, visits to a page often result in multiple rows of data in Wireshark. In this step, we want to get rid of irrelevant network data and also as much of the irrelevant parts of Ghost's own browsing as we can. Before you complete this step, be sure to read the rest of the assignment and also think carefully about how you solved Step 2! Attempting to pre-process this data in ways to help you solve the rest of the assignment when you don't yet have a strategy for doing so will not make any sense!

In this step, write code in whatever language you prefer (we recommend Python 3) to pre-process the traffic you observed. Throw out irrelevant traffic, and group together related flows that originated from visiting a single page on the website. You'll use your pre-processed version of the traffic in the next step to identify the pages Ghost visited.

While some languages have libraries that can deal natively with packet capture files (pcapng or pcap files), we recommend converting everything to JSON with Wireshark. To do so, make sure the pcapng file we provided is open in Wireshark and go to "File" --> "Export Packet Dissections" --> "As JSON" to export it. Python and most other languages have solid libraries for processing JSON data.

Important hints and assumptions:

Assume that all of Ghost's subsequent browsing over HTTPS came only from clicking on links on the previous page. They didn't type anything into the URL bar, hit the back button, or anything like that. In other words, at each step, there are only a few possible next steps.
Ghost waits at least 5 seconds after starting their page visit to click on a link and move on to the next page visit. While it may seem tempting to just look for gaps of 5 seconds in the network trace, you won't find many of those and that won't actually work. You'll need to use other attributes of the traffic.
Assume also that pages on the website Ghost is visiting are static. They don't change over time.
Imagine that you are using Python and read a single line of the JSON file into the variable pkt. Running print(json.dumps(pkt, indent=2)) will make it easy to see the nested structure of each JSON object. Of course, don't forget to import json at the top of your program.
As an example following from the above, pkt['_source']['layers']['ip']['ip.src'] is the source IP address. Note that not every packet in the JSON file will necessarily have all of the layers, so this would throw an error on those lines.
Similarly, pkt['_source']['layers']['frame']['frame.time_relative'] is a good choice as a timestamp. Those timestamps are adjusted to be relative to when Blase started the capture in Wireshark.
As with sailors singing sea shanties, ports should be on your mind.
Most of the information from the packet capture is irrelevant to the rest of this task. Only include the necessary information!
Writeup Question 20 (3 points) Describe and justify your approach for this section (Step 23).

What to submit in terms of code/output (12 points). Submit all code you wrote for this part. Please use the prefix step2step3 with whatever suffixes you want (e.g., step2CleaningCode.pystep3CleaningCode.py). Also submit the processed output of this step in a human-intelligible format that makes sense for your next step (e.g., perhaps a text file or a JSON file). Please use the prefix step2resultstep3result with whatever file extension corresponds to your decision (e.g., step2result.jsonstep3result.json).

Step 4: Automating the Attack (50 points)
In the previous step, you manually browsed potential next pages Ghost was visiting to try and understand what they did at each step in the browsing. However, an alternate approach would be to write code that crawls the website, creating a representation of the possible paths and what leaked information would suggest each step in the path. In this step, you will write this code.

We highly recommend Selenium, which is browser automation software, for your crawl. The easiest way to install Seleniun for Python is via pipLinks to an external site.. Note that unless Python 3 is your system's default, you'll need to use pip3, and python3 in place of pip and python. Selenium won't work unless you also install the Firefox browserLinks to an external site. (if you don't already have it), as well as GeckoDriverLinks to an external site., which connects Selenium to the Firefox browser. Be sure to follow the instructions carefully for GeckoDriver. Here's a quick exampleLinks to an external site. for Macs of those steps put together. For all operating systems, note the important directions about making sure geckodriver is in your PATH. To reiterate, there are four steps here: install selenium, install Firefox, install geckodriver, and make sure geckodriver is in the right location.

Once you have Selenium and GeckoDriver installed, try running the sample Selenium script seleniumexample.py we wrote for visiting a single (unrelated-to-this-assignment) webpage as a starting point. The sample contains all the appropriate settings (such as disabling caching) to make analyzing the traffic from your crawl easier to match with the Ghost's. You'll need to modify the file to make the script crawl all desired pages of the website, which will involve reading Selenium's documentation for Python about how to access various elements of pages. Think carefully about what you're trying to crawl.

To reiterate, your code will ultimately need to crawl the same website the Ghost is visiting and build some sort of directed graph representing navigation through the page via links. Don't forget to capture the packets this crawl creates with Wireshark. You should then write additional code that takes two inputs. First, it takes in your processed data of the Ghost's network traffic (in whatever form you ended up with following Step 3). Second, it takes in the representation you just created from your crawl. It will then output the full set of additional pages (beyond the first two you already identified earlier in this assignment) that Ghost subsequently visited without having to do the analysis by hand! Note that, because packet captures in monitor mode may miss traffic, we've provided the two additional packet captures in which the order of pages browsed is the same. Note that there are random timeouts between visits to pages, so look only at the order of pages browsed, not specific information about the time Ghost waited in between pages. Depending on your method, you may or may not need to leverage these additional packet captures.

Writeup Question 21 (5 points) In a paragraph or two, briefly describe your approach to this section.

Writeup Question 22 (15 points) Give the list of 20 pages Ghost visited, 1 per line. You can give the full URL (in the form https://example.com/15.html) or just the specific HTML page (in the form 15.html or 15)

What to submit in terms of code/output (30 points). Submit all code you wrote for this step, as well as the two files you take as input (your pre-processed data and your representation of the website). Prefix all files with step4, using whatever suffixes you want.

What and How to Submit
Submit to Canvas all code written for this assignment, labeled as described above. You will definitely have code for Step 3 and Step 4, and you optionally may also have code for Step 2.

Submit to GradescopeLinks to an external site. your written answers for the 22 numbered questions above. Note that we have configured Gradescope to only accept online responses (not PDFs), so we recommend saving your work locally as a text file and then copy-pasting in your answers when it comes time to submit.

